# 🔊 Sherpa-ONNX TTS 音量优化更新

## 📌 问题说明

您反馈 TTS 生成的语音较轻，这是因为原始实现没有对音频进行音量增益处理。

## ✅ 已完成的优化

### 1. **添加音量控制功能**

在 `tts_service.py` 中新增了 `apply_volume_gain()` 函数：
- 使用 NumPy 进行音频增益处理
- 默认音量倍数：**1.5x**（比原始音量提高 50%）
- 支持范围：**0.5x - 3.0x**
- 自动防削波（clipping）保护，避免音频失真

### 2. **API 参数更新**

现在所有 API 端点都支持 `volume` 参数：

#### `/api/tts` 端点
```json
{
  "text": "要转换的文本",
  "speed": 1.0,
  "volume": 1.5  // 新增：音量倍数，默认 1.5
}
```

#### `/api/tts/stream` 端点（小智使用）
```json
{
  "text": "{prompt_text}",
  "speed": 1.0,
  "volume": 1.5  // 新增：音量倍数，默认 1.5
}
```

### 3. **依赖更新**

- 添加了 `numpy` 依赖用于音频处理
- 更新了 `Dockerfile` 和 `build_docker_image.py`

---

## 🚀 更新部署步骤

### **步骤 1: 在 Windows 上重新构建镜像**

```powershell
# 1. 删除旧的依赖包（如果存在）
Remove-Item -Recurse -Force python-packages -ErrorAction SilentlyContinue

# 2. 删除旧的 Docker 镜像
docker rmi sherpa-onnx-tts:latest -f

# 3. 重新构建镜像
python build_docker_image.py
```

**构建过程**：
- 自动下载 `numpy` 等依赖
- 构建新的 Docker 镜像（包含音量控制功能）
- 测试容器运行
- 导出离线镜像包

**预计时间**：5-10 分钟

---

### **步骤 2: 传输到 CentOS 服务器**

```bash
# 使用 scp 传输部署包
scp -r docker-deployment-<timestamp> user@10.80.127.51:/home/app/sherpa-onnx-deploy/
```

---

### **步骤 3: 在 CentOS 上重新部署**

```bash
# 1. 进入部署目录
cd /home/app/sherpa-onnx-deploy/docker-deployment-<timestamp>

# 2. 停止旧服务
sudo docker-compose down

# 3. 删除旧镜像
sudo docker rmi sherpa-onnx-tts:latest

# 4. 运行部署脚本
chmod +x deploy_centos_docker.sh
./deploy_centos_docker.sh
```

---

## 📋 小智配置更新

### **方案 1：使用默认音量（推荐）**

不修改小智配置，使用 API 默认的 **1.5x** 音量：

```json
{
  "text": "{prompt_text}",
  "speed": 1.0
}
```

> **说明**：即使不传 `volume` 参数，API 也会自动使用 1.5x 音量

---

### **方案 2：自定义音量**

如果 1.5x 音量仍然不够，可以在小智配置中添加 `volume` 参数：

#### **更大音量（2倍）**
```json
{
  "text": "{prompt_text}",
  "speed": 1.0,
  "volume": 2.0
}
```

#### **更小音量（原始音量）**
```json
{
  "text": "{prompt_text}",
  "speed": 1.0,
  "volume": 1.0
}
```

#### **最大音量（3倍）**
```json
{
  "text": "{prompt_text}",
  "speed": 1.0,
  "volume": 3.0
}
```

---

## 🧪 测试验证

### **方法 1：curl 测试**

在 CentOS 服务器上：

```bash
# 测试默认音量（1.5x）
curl -X POST http://10.80.127.51:5000/api/tts/stream \
  -H "Content-Type: application/json" \
  -d '{"text": "音量测试，默认1.5倍"}' \
  -o test_default.wav

# 测试更大音量（2.0x）
curl -X POST http://10.80.127.51:5000/api/tts/stream \
  -H "Content-Type: application/json" \
  -d '{"text": "音量测试，2倍音量", "volume": 2.0}' \
  -o test_2x.wav

# 测试最大音量（3.0x）
curl -X POST http://10.80.127.51:5000/api/tts/stream \
  -H "Content-Type: application/json" \
  -d '{"text": "音量测试，3倍音量", "volume": 3.0}' \
  -o test_3x.wav
```

然后下载这些文件到本地试听对比。

---

### **方法 2：查看服务日志**

```bash
sudo docker-compose logs -f
```

您应该能看到类似的日志：

```
sherpa-onnx-tts-service | INFO - Stream TTS: 音量测试... (speed=1.0, volume=1.5)
sherpa-onnx-tts-service | INFO - TTS generated successfully: duration=2.34s, gen_time=0.52s, RTF=0.222, volume=1.5x
```

---

## 📊 音量参数建议

根据使用场景选择合适的音量：

| 场景 | 推荐音量 | 参数值 |
|------|---------|--------|
| **正常使用**（默认） | 1.5 倍 | `"volume": 1.5` |
| **安静环境** | 1.0 倍（原始） | `"volume": 1.0` |
| **嘈杂环境** | 2.0 倍 | `"volume": 2.0` |
| **需要特别响亮** | 2.5-3.0 倍 | `"volume": 2.5` 或 `3.0` |

> ⚠️ **注意**：音量过大（>2.5x）可能导致轻微失真，但代码中已添加削波保护。

---

## 🔧 技术实现细节

### 音量增益算法

```python
def apply_volume_gain(samples, volume=1.0):
    """
    应用音量增益
    
    Args:
        samples: 音频样本数组
        volume: 音量倍数（1.0 = 原音量，2.0 = 两倍音量）
    
    Returns:
        处理后的音频样本
    """
    if volume == 1.0:
        return samples
    
    # 转换为 numpy 数组
    audio_array = np.array(samples, dtype=np.float32)
    
    # 应用增益
    audio_array = audio_array * volume
    
    # 限制在 [-1.0, 1.0] 范围内，防止削波失真
    audio_array = np.clip(audio_array, -1.0, 1.0)
    
    return audio_array
```

### 处理流程

1. **生成原始音频**：Sherpa-ONNX 生成原始音频样本
2. **应用增益**：使用 NumPy 将样本值乘以 `volume` 倍数
3. **削波保护**：使用 `np.clip()` 确保样本值在 [-1.0, 1.0] 范围内
4. **保存音频**：使用 `soundfile` 保存为 WAV 格式

---

## ❓ 常见问题

### Q1: 更新后音量还是不够怎么办？

**A**: 
1. 首先确认新镜像已部署：`sudo docker images | grep sherpa-onnx-tts`
2. 查看容器日志确认使用了新版本：`sudo docker-compose logs | grep "version"`
3. 尝试更大的音量值：`"volume": 2.0` 或 `2.5`

### Q2: 音量过大会失真吗？

**A**: 代码中已经添加了削波保护（`np.clip`），会自动限制音频幅度在合理范围内。即使设置 `volume: 3.0`，也不会产生严重失真。

### Q3: 不传 volume 参数会怎样？

**A**: API 会自动使用默认值 `1.5`，相当于原始音量的 1.5 倍。

### Q4: 如何临时测试不同音量？

**A**: 可以直接在小智配置中修改 `volume` 值，无需重启服务：
```json
{"text": "{prompt_text}", "speed": 1.0, "volume": 2.0}
```

### Q5: 能否只更新服务代码，不重新构建镜像？

**A**: 不建议。因为需要添加 `numpy` 依赖，建议完整重新构建镜像。

---

## 📚 相关文件

本次更新涉及的文件：

- ✅ `tts_service.py` - 添加音量控制功能
- ✅ `Dockerfile` - 添加 numpy 依赖
- ✅ `build_docker_image.py` - 更新依赖下载列表
- ✅ `音量优化更新说明.md` - 本文档

---

## 🎯 下一步操作

1. **立即行动**：运行 `python build_docker_image.py` 重新构建镜像
2. **传输部署**：将新的部署包传输到 CentOS 服务器
3. **重新部署**：在服务器上运行 `./deploy_centos_docker.sh`
4. **测试验证**：使用 curl 测试不同音量效果
5. **更新配置**（可选）：如果默认 1.5x 不够，在小智配置中添加 `volume` 参数

---

## ✨ 更新摘要

| 项目 | 更新前 | 更新后 |
|------|-------|--------|
| **默认音量** | 原始音量（1.0x） | 1.5 倍音量（1.5x） |
| **音量控制** | ❌ 不支持 | ✅ 支持 0.5x - 3.0x |
| **API 参数** | `text`, `speed` | `text`, `speed`, `volume` |
| **音频处理** | 无处理 | NumPy 增益 + 削波保护 |
| **版本号** | 1.0.0 | 1.1.0 |

---

**创建时间**: 2025-10-22  
**作者**: AI Assistant  
**状态**: ✅ 已完成开发，待部署

