# 🔧 Sherpa-ONNX TTS 故障排除指南

## ⚠️ 常见问题与解决方案

### 问题1：vits-melo-tts-zh_en 模型加载失败

**错误信息**：
```
Please provide --vits-dict-dir for Chinese TTS models using jieba
```

**原因分析**：
vits-melo-tts-zh_en 模型在某些 sherpa-onnx 版本中可能存在兼容性问题。这个模型使用了特殊的前端处理方式。

**解决方案**：

#### 方案A：升级 sherpa-onnx（推荐）

```bash
# 升级到最新版本
pip install --upgrade sherpa-onnx

# 验证版本
python -c "import sherpa_onnx; print(sherpa_onnx.__version__)"
```

最新版本应该是 1.10.0 或更高。

#### 方案B：使用其他中英混合TTS模型

如果升级后问题仍然存在，建议使用以下替代模型：

**1. vits-piper-en_GB-cori-medium（英文）**

```bash
# 下载模型
wget https://github.com/k2-fsa/sherpa-onnx/releases/download/tts-models/vits-piper-en_GB-cori-medium.tar.bz2
tar xvf vits-piper-en_GB-cori-medium.tar.bz2

# 使用方法
python test_tts.py --model-dir=vits-piper-en_GB-cori-medium
```

**Python 代码**：
```python
import sherpa_onnx
import soundfile as sf

config = sherpa_onnx.OfflineTtsConfig(
    model=sherpa_onnx.OfflineTtsModelConfig(
        vits=sherpa_onnx.OfflineTtsVitsModelConfig(
            model="./vits-piper-en_GB-cori-medium/en_GB-cori-medium.onnx",
            tokens="./vits-piper-en_GB-cori-medium/tokens.txt",
            data_dir="./vits-piper-en_GB-cori-medium/espeak-ng-data",
        ),
        num_threads=4,
        provider="cpu",
    ),
)

tts = sherpa_onnx.OfflineTts(config)
audio = tts.generate("Hello world!", sid=0, speed=1.0)
sf.write("output.wav", audio.samples, samplerate=audio.sample_rate)
```

**2. vits-icefall-zh-aishell3（中文多说话人）**

```bash
# 下载模型
wget https://github.com/k2-fsa/sherpa-onnx/releases/download/tts-models/vits-icefall-zh-aishell3.tar.bz2
tar xvf vits-icefall-zh-aishell3.tar.bz2

# 使用方法
python test_tts_zh.py
```

**Python 代码**：
```python
import sherpa_onnx
import soundfile as sf

config = sherpa_onnx.OfflineTtsConfig(
    model=sherpa_onnx.OfflineTtsModelConfig(
        vits=sherpa_onnx.OfflineTtsVitsModelConfig(
            model="./vits-icefall-zh-aishell3/model.onnx",
            lexicon="./vits-icefall-zh-aishell3/lexicon.txt",
            tokens="./vits-icefall-zh-aishell3/tokens.txt",
        ),
        num_threads=4,
        provider="cpu",
    ),
    rule_fsts="./vits-icefall-zh-aishell3/phone.fst,./vits-icefall-zh-aishell3/date.fst,./vits-icefall-zh-aishell3/number.fst",
)

tts = sherpa_onnx.OfflineTts(config)
audio = tts.generate("你好世界", sid=21, speed=1.0)
sf.write("output.wav", audio.samples, samplerate=audio.sample_rate)
```

#### 方案C：使用C++命令行工具

如果 Python API 有问题，可以使用编译好的 C++ 工具：

```bash
# Windows
sherpa-onnx-offline-tts.exe \
  --vits-model=./vits-melo-tts-zh_en/model.onnx \
  --vits-lexicon=./vits-melo-tts-zh_en/lexicon.txt \
  --vits-tokens=./vits-melo-tts-zh_en/tokens.txt \
  --output-filename=output.wav \
  "你好世界"

# Linux
./sherpa-onnx-offline-tts \
  --vits-model=./vits-melo-tts-zh_en/model.onnx \
  --vits-lexicon=./vits-melo-tts-zh_en/lexicon.txt \
  --vits-tokens=./vits-melo-tts-zh_en/tokens.txt \
  --output-filename=output.wav \
  "你好世界"
```

---

### 问题2：ImportError: No module named 'sherpa_onnx'

**解决方案**：

```bash
# 重新安装
pip uninstall sherpa-onnx
pip install sherpa-onnx

# 如果还是失败，尝试从源码安装
pip install sherpa-onnx --no-binary :all:
```

---

### 问题3：soundfile 相关错误

**错误信息**：
```
OSError: cannot load library 'libsndfile.so'
```

**解决方案**：

**Windows**：
```powershell
pip install soundfile --upgrade
```

**Linux (Ubuntu/Debian)**：
```bash
sudo apt-get install libsndfile1
pip install soundfile
```

**Linux (CentOS/RHEL)**：
```bash
sudo yum install libsndfile
pip3 install soundfile
```

---

### 问题4：生成的音频无声音

**检查步骤**：

1. 验证音频文件大小
```bash
ls -lh output.wav
```

2. 检查音频信息
```bash
# Linux
soxi output.wav

# Python
python -c "import soundfile as sf; print(sf.info('output.wav'))"
```

3. 尝试不同的文本
```python
# 简单文本
audio = tts.generate("hello", sid=0, speed=1.0)

# 中文文本
audio = tts.generate("你好", sid=0, speed=1.0)
```

---

### 问题5：内存不足

**错误信息**：
```
MemoryError: Unable to allocate...
```

**解决方案**：

1. 减少线程数
```python
config = sherpa_onnx.OfflineTtsConfig(
    model=sherpa_onnx.OfflineTtsModelConfig(
        num_threads=2,  # 降低线程数
    )
)
```

2. 分段处理长文本
```python
def generate_long_text(tts, text, max_length=200):
    """分段生成长文本"""
    sentences = text.split('。')
    all_samples = []
    
    for sentence in sentences:
        if not sentence.strip():
            continue
        audio = tts.generate(sentence + '。', sid=0, speed=1.0)
        all_samples.extend(audio.samples)
    
    return all_samples
```

---

### 问题6：CentOS 编译错误

**错误信息**：
```
error: command 'gcc' failed
```

**解决方案**：

```bash
# 安装编译工具
sudo yum groupinstall "Development Tools"
sudo yum install python3-devel

# 或者单独安装
sudo yum install gcc gcc-c++ make python3-devel

# 然后重新安装
pip3 install sherpa-onnx
```

---

### 问题7：ONNX Runtime 错误

**错误信息**：
```
Failed to load ONNX model
```

**解决方案**：

1. 检查 ONNX Runtime 版本
```python
import onnxruntime
print(onnxruntime.__version__)
```

2. 重新安装 ONNX Runtime
```bash
pip uninstall onnxruntime
pip install onnxruntime
```

3. 验证模型文件
```bash
# 检查模型文件完整性
ls -lh vits-melo-tts-zh_en/model.onnx

# 应该显示约 163 MB
```

---

## 🎯 推荐的模型选择

根据您的需求选择合适的模型：

| 需求 | 推荐模型 | 优点 | 缺点 |
|------|---------|------|------|
| 纯英文 | vits-piper-en_US-lessac-medium | 质量高，速度快 | 只支持英文 |
| 纯中文 | vits-icefall-zh-aishell3 | 多说话人，质量好 | 较大（116MB） |
| 中英混合 | ~~vits-melo-tts-zh_en~~ | 中英混合 | **当前版本有兼容性问题** |
| 中英混合（替代） | kokoro-multi-lang-v1_0 | 多语言支持 | 配置复杂 |

---

## 📞 获取帮助

如果问题仍未解决，请：

1. **查看日志**
   ```python
   # 启用调试模式
   config = sherpa_onnx.OfflineTtsConfig(
       model=sherpa_onnx.OfflineTtsModelConfig(
           debug=True,  # 启用详细日志
       )
   )
   ```

2. **检查版本信息**
   ```python
   import sherpa_onnx
   import onnxruntime
   import soundfile
   import sys
   
   print("Python:", sys.version)
   print("sherpa-onnx:", sherpa_onnx.__version__)
   print("onnxruntime:", onnxruntime.__version__)
   print("soundfile:", soundfile.__version__)
   ```

3. **访问官方资源**
   - GitHub Issues: https://github.com/k2-fsa/sherpa-onnx/issues
   - 官方文档: https://k2-fsa.github.io/sherpa/onnx/tts/
   - 讨论区: https://github.com/k2-fsa/sherpa-onnx/discussions

---

## ✅ 成功部署检查清单

- [ ] sherpa-onnx 版本 >= 1.10.0
- [ ] 模型文件完整（model.onnx, lexicon.txt, tokens.txt）
- [ ] Python 版本 3.8-3.11
- [ ] 测试脚本能成功运行
- [ ] 生成的音频可以播放
- [ ] RTF < 1.0（性能可接受）

---

**最后更新**: 2024-10-21  
**适用版本**: sherpa-onnx 1.10.0+

