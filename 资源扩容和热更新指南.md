# 🚀 Sherpa-ONNX TTS 资源扩容和热更新指南

## 📊 资源配置方案对比

### 当前配置（标准配置）
```yaml
CPU:    4 核（limits: 4.0, reservations: 2.0）
内存:   4GB（limits: 4G, reservations: 2G）
线程:   NUM_THREADS=4
工作进程: MAX_WORKERS=4
文本长度: MAX_TEXT_LENGTH=500
```
**适用场景**: 轻量级使用，QPS < 10

---

### 推荐方案一：中等配置 6核6G ⭐
```yaml
CPU:    6 核（limits: 6.0, reservations: 3.0）
内存:   6GB（limits: 6G, reservations: 3G）
线程:   NUM_THREADS=6
工作进程: MAX_WORKERS=6
文本长度: MAX_TEXT_LENGTH=800
```
**适用场景**: 
- 中等并发（QPS 10-20）
- 文本长度 < 800 字符
- 响应时间要求 < 2秒

**性能提升**: 
- ✅ 吞吐量提升 **50%**
- ✅ 并发能力提升 **50%**
- ✅ 延迟降低约 **30%**

**文件**: `docker-compose-中配6核6G.yml`

---

### 推荐方案二：高配 8核8G ⭐⭐
```yaml
CPU:    8 核（limits: 8.0, reservations: 4.0）
内存:   8GB（limits: 8G, reservations: 4G）
线程:   NUM_THREADS=8
工作进程: MAX_WORKERS=8
文本长度: MAX_TEXT_LENGTH=1000
```
**适用场景**: 
- 高并发场景（QPS 20-40）
- 文本长度 < 1000 字符
- 响应时间要求 < 1秒
- 多用户同时访问

**性能提升**: 
- ✅ 吞吐量提升 **100%**
- ✅ 并发能力提升 **100%**
- ✅ 延迟降低约 **50%**

**文件**: `docker-compose-高配8核8G.yml`

---

### 方案三：极高配 16核16G ⭐⭐⭐
```yaml
CPU:    16 核（limits: 16.0, reservations: 8.0）
内存:   16GB（limits: 16G, reservations: 8G）
线程:   NUM_THREADS=16
工作进程: MAX_WORKERS=16
文本长度: MAX_TEXT_LENGTH=2000
```
**适用场景**: 
- 超高并发场景（QPS 40-80）
- 文本长度 < 2000 字符
- 响应时间要求 < 0.5秒
- 企业级生产环境

**性能提升**: 
- ✅ 吞吐量提升 **300%**
- ✅ 并发能力提升 **300%**
- ✅ 延迟降低约 **70%**

**文件**: `docker-compose-高配16核16G.yml`

---

## 🎯 推荐选择

根据您的使用情况，推荐：

| 当前问题 | 推荐方案 | 资源申请 |
|---------|---------|---------|
| 偶尔卡顿 | **6核6G** | CPU +2核, 内存 +2G |
| 频繁卡顿 | **8核8G** | CPU +4核, 内存 +4G |
| 严重延迟 | **16核16G** | CPU +12核, 内存 +12G |
| 高峰期卡顿 | **8核8G** | CPU +4核, 内存 +4G |

> 💡 **建议**: 先升级到 **8核8G**，如果还不够再考虑 16核16G

---

## 🔧 热更新操作步骤（零停机）

### 方法一：直接替换配置文件（推荐）

```bash
# 1. 进入部署目录
cd /home/app/sherpa-onnx-deploy/docker-deployment-<timestamp>

# 2. 备份当前配置
cp docker-compose.yml docker-compose.yml.backup

# 3. 选择配置方案（选择其一）
# 方案 A: 6核6G
cp docker-compose-中配6核6G.yml docker-compose.yml

# 方案 B: 8核8G（推荐）
cp docker-compose-高配8核8G.yml docker-compose.yml

# 方案 C: 16核16G
cp docker-compose-高配16核16G.yml docker-compose.yml

# 4. 热更新服务（自动平滑重启）
sudo docker-compose up -d

# 5. 验证更新
sudo docker-compose ps
sudo docker stats sherpa-onnx-tts-service
```

**优点**: 
- ✅ 自动平滑重启，服务中断时间 < 3秒
- ✅ 配置立即生效
- ✅ 保留所有数据

---

### 方法二：在线修改配置

```bash
# 1. 进入部署目录
cd /home/app/sherpa-onnx-deploy/docker-deployment-<timestamp>

# 2. 编辑配置文件
vi docker-compose.yml

# 3. 修改以下参数（例如升级到 8核8G）
# 将 cpus 改为 '8.0'
# 将 memory 改为 8G
# 将 NUM_THREADS 改为 8
# 将 MAX_WORKERS 改为 8

# 4. 保存并热更新
sudo docker-compose up -d

# 5. 验证
sudo docker stats sherpa-onnx-tts-service
```

---

### 方法三：使用 Docker 直接更新（不停机）

```bash
# 更新 CPU 限制
sudo docker update --cpus="8.0" sherpa-onnx-tts-service

# 更新内存限制
sudo docker update --memory="8g" sherpa-onnx-tts-service

# 验证
sudo docker inspect sherpa-onnx-tts-service | grep -A 5 "Resources"
```

> ⚠️ **注意**: 此方法只更新容器资源限制，不更新环境变量（NUM_THREADS、MAX_WORKERS），建议使用方法一。

---

## 📈 性能监控和验证

### 1. 实时监控资源使用

```bash
# 实时查看 CPU 和内存使用率
sudo docker stats sherpa-onnx-tts-service

# 输出示例：
# CONTAINER ID   NAME                      CPU %     MEM USAGE / LIMIT   MEM %
# abc123def456   sherpa-onnx-tts-service   45.67%    2.1GiB / 8GiB      26.25%
```

### 2. 查看容器配置

```bash
# 查看当前资源限制
sudo docker inspect sherpa-onnx-tts-service | grep -A 10 "Resources"

# 查看环境变量
sudo docker exec sherpa-onnx-tts-service printenv | grep -E "NUM_THREADS|MAX_WORKERS"
```

### 3. 服务健康检查

```bash
# 健康检查
curl http://localhost:5000/health

# 查看服务信息
curl http://localhost:5000/api/info

# 输出应包含：
# "version": "1.1.0"
# "capabilities": {...}
```

### 4. 性能测试

```bash
# 测试响应时间
time curl -X POST http://localhost:5000/api/tts/stream \
  -H "Content-Type: application/json" \
  -d '{"text": "这是一个性能测试"}' \
  -o test.wav

# 并发测试（需要 Apache Bench）
ab -n 100 -c 10 -p test.json -T application/json http://localhost:5000/api/tts/stream
```

---

## 🔍 性能问题诊断

### 检查 1: CPU 使用率

```bash
sudo docker stats sherpa-onnx-tts-service --no-stream
```

**判断**:
- CPU % > 90% → **CPU 不足，需要扩容**
- CPU % < 30% → CPU 充足，问题可能在其他地方

### 检查 2: 内存使用率

```bash
sudo docker stats sherpa-onnx-tts-service --no-stream
```

**判断**:
- MEM % > 90% → **内存不足，需要扩容**
- MEM % < 50% → 内存充足

### 检查 3: 服务日志

```bash
sudo docker-compose logs --tail=100 -f
```

**关注关键信息**:
- `generation_time` - 生成耗时
- `RTF` (Real Time Factor) - 实时率
- 错误信息

### 检查 4: 并发请求数

```bash
# 查看当前活跃连接数
sudo docker exec sherpa-onnx-tts-service netstat -an | grep :5000 | wc -l
```

**判断**:
- 活跃连接 > MAX_WORKERS → **工作进程不足**
- 活跃连接 << MAX_WORKERS → 并发压力不大

---

## 📋 扩容决策表

根据监控数据选择扩容方案：

| CPU 使用率 | 内存使用率 | 延迟情况 | 推荐方案 |
|-----------|-----------|---------|---------|
| 70-90% | 60-80% | 偶尔延迟 | **6核6G** |
| >90% | >80% | 频繁延迟 | **8核8G** |
| 持续>95% | 持续>90% | 严重延迟 | **16核16G** |
| <50% | <50% | 仍然延迟 | 检查网络/模型 |

---

## 🎬 完整热更新流程

### 场景：从 4核4G 升级到 8核8G

```bash
# ========================================
# 步骤 1: 准备阶段
# ========================================

# 进入目录
cd /home/app/sherpa-onnx-deploy/docker-deployment-<timestamp>

# 检查当前状态
echo "当前配置:"
sudo docker stats sherpa-onnx-tts-service --no-stream
curl http://localhost:5000/health

# 备份当前配置
cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S)
echo "✓ 配置已备份"


# ========================================
# 步骤 2: 应用新配置
# ========================================

# 替换为高配方案
cp docker-compose-高配8核8G.yml docker-compose.yml
echo "✓ 配置已更新为 8核8G"


# ========================================
# 步骤 3: 热更新服务
# ========================================

echo "正在热更新服务..."
sudo docker-compose up -d

# 等待服务启动
echo "等待服务初始化（30秒）..."
sleep 30


# ========================================
# 步骤 4: 验证更新
# ========================================

echo -e "\n验证新配置:"
sudo docker stats sherpa-onnx-tts-service --no-stream

echo -e "\n验证环境变量:"
sudo docker exec sherpa-onnx-tts-service printenv | grep -E "NUM_THREADS|MAX_WORKERS"

echo -e "\n健康检查:"
curl http://localhost:5000/health

echo -e "\n服务信息:"
curl http://localhost:5000/api/info


# ========================================
# 步骤 5: 性能测试
# ========================================

echo -e "\n性能测试:"
time curl -X POST http://localhost:5000/api/tts/stream \
  -H "Content-Type: application/json" \
  -d '{"text": "这是升级后的性能测试，8核8G配置"}' \
  -o /tmp/test_8core.wav

echo -e "\n✅ 热更新完成！"
```

**预期结果**:
- 服务中断时间 < 5秒
- CPU 限制从 4核 提升到 8核
- 内存限制从 4G 提升到 8G
- NUM_THREADS 从 4 提升到 8
- MAX_WORKERS 从 4 提升到 8

---

## 🛡️ 回滚操作

如果更新后出现问题，立即回滚：

```bash
# 1. 恢复备份配置
cp docker-compose.yml.backup docker-compose.yml

# 2. 重启服务
sudo docker-compose up -d

# 3. 验证
curl http://localhost:5000/health
```

---

## 📊 性能对比测试

升级后建议进行对比测试：

```bash
# 创建测试脚本
cat > performance_test.sh << 'EOF'
#!/bin/bash

echo "开始性能测试..."

# 单次请求测试
echo -e "\n===== 单次请求测试 ====="
for i in {1..5}; do
  echo "测试 $i:"
  time curl -X POST http://localhost:5000/api/tts/stream \
    -H "Content-Type: application/json" \
    -d '{"text": "性能测试文本，测试TTS服务响应速度"}' \
    -o /tmp/test_$i.wav 2>&1 | grep real
done

# 并发测试
echo -e "\n===== 并发测试（10个请求）====="
for i in {1..10}; do
  curl -X POST http://localhost:5000/api/tts/stream \
    -H "Content-Type: application/json" \
    -d '{"text": "并发测试'$i'"}' \
    -o /tmp/concurrent_$i.wav &
done
wait

echo -e "\n✅ 测试完成"
EOF

# 运行测试
chmod +x performance_test.sh
./performance_test.sh
```

---

## 💡 优化建议

### 1. 根据实际负载动态调整

```bash
# 监控一周，记录高峰期 CPU 使用率
sudo docker stats sherpa-onnx-tts-service --no-stream >> /tmp/stats.log

# 分析日志，找出峰值
cat /tmp/stats.log | sort -k3 -nr | head -10
```

### 2. 启用请求队列（如果高并发）

在 `tts_service.py` 中可以添加请求队列机制（未来优化）。

### 3. 多实例负载均衡（极高负载）

如果单实例仍不够，可以部署多个实例 + Nginx 负载均衡：

```yaml
# docker-compose-多实例.yml
services:
  tts-1:
    ...
    ports:
      - "5001:5000"
  
  tts-2:
    ...
    ports:
      - "5002:5000"
  
  nginx:
    image: nginx
    ports:
      - "5000:80"
    # 负载均衡配置
```

---

## 📞 支持和帮助

### 常见问题

**Q1: 更新后服务启动失败？**

A: 
```bash
# 查看日志
sudo docker-compose logs

# 检查资源是否充足
free -h
nproc
```

**Q2: 更新后性能没有提升？**

A:
```bash
# 验证环境变量是否生效
sudo docker exec sherpa-onnx-tts-service printenv | grep THREADS

# 如果没有生效，需要重新创建容器
sudo docker-compose down
sudo docker-compose up -d
```

**Q3: 如何确定当前使用的配置？**

A:
```bash
# 查看当前配置文件
cat docker-compose.yml | grep -A 5 "resources:"

# 查看实际运行参数
sudo docker inspect sherpa-onnx-tts-service | grep -A 10 "Resources"
```

---

## 📝 资源申请模板

### 给 IT 部门的申请邮件

```
主题：Sherpa-ONNX TTS 服务器资源扩容申请

尊敬的 IT 部门：

我们的 TTS 语音合成服务（IP: 10.80.127.51）目前配置为 4核4G，
在业务高峰期出现卡顿和延迟问题。

现申请资源扩容至：
- CPU: 8核（从 4核 提升）
- 内存: 8GB（从 4GB 提升）

扩容理由：
1. 当前 CPU 使用率峰值达 95%
2. 响应延迟从 0.5秒增加到 2-3秒
3. 影响小智智控台语音合成功能

预期效果：
- 吞吐量提升 100%
- 延迟降低 50%
- 支持并发请求数提升到 20-40 QPS

热更新方案：
采用 Docker Compose 热更新，服务中断时间 < 5秒。

请批准，谢谢！

附件：资源扩容和热更新指南.md
```

---

## ✅ 总结

| 配置方案 | CPU | 内存 | 适用场景 | 性能提升 |
|---------|-----|------|---------|---------|
| 当前配置 | 4核 | 4G | 轻量级 | - |
| **6核6G** | 6核 | 6G | 中等并发 | +50% |
| **8核8G** ⭐ | 8核 | 8G | 高并发 | +100% |
| **16核16G** | 16核 | 16G | 超高并发 | +300% |

**推荐操作**:
1. 立即升级到 **8核8G**
2. 使用 `docker-compose up -d` 热更新
3. 监控性能改善情况
4. 如果仍不够，再升级到 16核16G

---

**创建时间**: 2025-10-22  
**版本**: v1.0  
**状态**: ✅ 可立即执行

