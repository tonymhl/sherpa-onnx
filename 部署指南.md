# Sherpa-ONNX TTS 模型离线部署指南

## 📖 目录
- [Windows 本地测试环境搭建](#windows-本地测试环境搭建)
- [模型下载与测试](#模型下载与测试)
- [离线部署包制作](#离线部署包制作)
- [CentOS 服务器部署](#centos-服务器部署)

---

## 🪟 Windows 本地测试环境搭建

### 1. 安装 Python 环境

确保您的 Windows 系统已安装 Python 3.8 或更高版本。

```powershell
# 检查 Python 版本
python --version

# 如果未安装，请从官网下载：https://www.python.org/downloads/
```

### 2. 安装 sherpa-onnx Python 包

#### 方案A：在线安装（用于测试）

```powershell
# 安装 sherpa-onnx 及依赖
pip install sherpa-onnx soundfile

# 验证安装
python -c "import sherpa_onnx; print(sherpa_onnx.__version__)"
```

#### 方案B：离线安装准备（用于后续打包）

```powershell
# 1. 创建工作目录
mkdir D:\tts-offline-deploy
cd D:\tts-offline-deploy

# 2. 下载所有依赖包到本地
mkdir python-packages
pip download sherpa-onnx soundfile -d python-packages

# 3. 从本地安装（测试离线安装是否正常）
pip install --no-index --find-links=python-packages sherpa-onnx soundfile
```

---

## 📦 模型下载与测试

### 1. 下载 vits-melo-tts-zh_en 模型

```powershell
# 进入工作目录
cd D:\tts-offline-deploy

# 方法1：使用 PowerShell 下载
Invoke-WebRequest -Uri "https://github.com/k2-fsa/sherpa-onnx/releases/download/tts-models/vits-melo-tts-zh_en.tar.bz2" -OutFile "vits-melo-tts-zh_en.tar.bz2"

# 方法2：如果上述方法失败，可以使用浏览器手动下载
# 下载地址：https://github.com/k2-fsa/sherpa-onnx/releases/download/tts-models/vits-melo-tts-zh_en.tar.bz2
```

### 2. 解压模型文件

```powershell
# 需要安装 7-Zip 或 WinRAR 来解压 .tar.bz2 文件
# 使用 7-Zip 命令行解压（假设已安装）
"C:\Program Files\7-Zip\7z.exe" x vits-melo-tts-zh_en.tar.bz2
"C:\Program Files\7-Zip\7z.exe" x vits-melo-tts-zh_en.tar

# 或者可以使用 Python 解压
python -c "import tarfile; tarfile.open('vits-melo-tts-zh_en.tar.bz2').extractall()"
```

### 3. 创建测试脚本

将以下内容保存为 `test_tts.py`：

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import sherpa_onnx
import soundfile as sf
import time

def test_tts_zh_en():
    """测试中英文混合TTS"""
    
    # 配置模型路径
    tts_config = sherpa_onnx.OfflineTtsConfig(
        model=sherpa_onnx.OfflineTtsModelConfig(
            vits=sherpa_onnx.OfflineTtsVitsModelConfig(
                model="./vits-melo-tts-zh_en/model.onnx",
                lexicon="./vits-melo-tts-zh_en/lexicon.txt",
                tokens="./vits-melo-tts-zh_en/tokens.txt",
            ),
            num_threads=4,  # 根据您的CPU核心数调整
            debug=False,
            provider="cpu",
        ),
        max_num_sentences=1,
    )
    
    # 验证配置
    if not tts_config.validate():
        raise ValueError("配置验证失败，请检查模型文件路径")
    
    # 创建 TTS 对象
    tts = sherpa_onnx.OfflineTts(tts_config)
    
    # 测试用例
    test_cases = [
        ("纯中文测试：你好世界，这是一个语音合成测试。", "test_chinese.wav"),
        ("English test: Hello world, this is a text to speech test.", "test_english.wav"),
        ("中英混合：Hello大家好，today我们测试TTS功能。", "test_mixed.wav"),
        ("数字测试：今天是2024年10月21日，电话号码是13812345678。", "test_numbers.wav"),
    ]
    
    print("=" * 60)
    print("开始测试 vits-melo-tts-zh_en 模型")
    print("=" * 60)
    
    for i, (text, filename) in enumerate(test_cases, 1):
        print(f"\n[{i}/{len(test_cases)}] 测试文本: {text}")
        
        try:
            start_time = time.time()
            audio = tts.generate(text, sid=0, speed=1.0)
            end_time = time.time()
            
            if len(audio.samples) == 0:
                print(f"❌ 错误：音频生成失败")
                continue
            
            # 保存音频
            sf.write(
                filename,
                audio.samples,
                samplerate=audio.sample_rate,
                subtype="PCM_16",
            )
            
            # 计算性能指标
            elapsed_seconds = end_time - start_time
            audio_duration = len(audio.samples) / audio.sample_rate
            rtf = elapsed_seconds / audio_duration
            
            print(f"✅ 成功保存到: {filename}")
            print(f"   音频时长: {audio_duration:.2f}秒")
            print(f"   生成耗时: {elapsed_seconds:.2f}秒")
            print(f"   RTF (实时率): {rtf:.3f}")
            
        except Exception as e:
            print(f"❌ 生成失败: {str(e)}")
    
    print("\n" + "=" * 60)
    print("测试完成！")
    print("=" * 60)

if __name__ == "__main__":
    test_tts_zh_en()
```

### 4. 运行测试

```powershell
python test_tts.py
```

如果一切正常，您会看到生成了4个 WAV 音频文件。

---

## 📦 离线部署包制作

### 1. 准备离线部署包结构

```powershell
# 创建部署包目录
mkdir D:\tts-deploy-package
cd D:\tts-deploy-package

# 创建目录结构
mkdir models
mkdir python-packages
mkdir scripts
```

### 2. 收集所有必要文件

```powershell
# 复制模型文件
Copy-Item -Recurse D:\tts-offline-deploy\vits-melo-tts-zh_en models\

# 复制 Python 包
Copy-Item -Recurse D:\tts-offline-deploy\python-packages\* python-packages\

# 复制测试脚本
Copy-Item D:\tts-offline-deploy\test_tts.py scripts\
```

### 3. 创建自动化部署脚本

**Windows 部署脚本** (`deploy_windows.bat`)：

```batch
@echo off
chcp 65001
echo ===================================
echo Sherpa-ONNX TTS 离线部署脚本 (Windows)
echo ===================================
echo.

REM 检查 Python
python --version >nul 2>&1
if %errorlevel% neq 0 (
    echo [错误] 未检测到 Python，请先安装 Python 3.8+
    pause
    exit /b 1
)

echo [1/3] 安装 Python 依赖包...
pip install --no-index --find-links=python-packages sherpa-onnx soundfile

echo.
echo [2/3] 验证安装...
python -c "import sherpa_onnx; import soundfile; print('依赖包安装成功！')"

echo.
echo [3/3] 运行测试...
cd scripts
python test_tts.py

echo.
echo ===================================
echo 部署完成！
echo ===================================
pause
```

**Linux/CentOS 部署脚本** (`deploy_centos.sh`)：

```bash
#!/bin/bash

echo "==================================="
echo "Sherpa-ONNX TTS 离线部署脚本 (CentOS)"
echo "==================================="
echo

# 检查 Python
if ! command -v python3 &> /dev/null; then
    echo "[错误] 未检测到 Python3，请先安装"
    exit 1
fi

echo "[1/4] 安装系统依赖..."
sudo yum install -y gcc gcc-c++ make

echo
echo "[2/4] 创建虚拟环境（推荐）..."
python3 -m venv venv
source venv/bin/activate

echo
echo "[3/4] 安装 Python 依赖包..."
pip3 install --no-index --find-links=python-packages sherpa-onnx soundfile

echo
echo "[4/4] 验证安装..."
python3 -c "import sherpa_onnx; import soundfile; print('依赖包安装成功！')"

echo
echo "运行测试："
cd scripts
python3 test_tts.py

echo
echo "==================================="
echo "部署完成！"
echo "==================================="
```

### 4. 创建 README 文件

```powershell
# 创建 README.md
@"
# Sherpa-ONNX TTS 离线部署包

## 📦 包含内容

- `models/vits-melo-tts-zh_en/`: TTS 模型文件
- `python-packages/`: Python 离线安装包
- `scripts/`: 测试脚本
- `deploy_windows.bat`: Windows 自动部署脚本
- `deploy_centos.sh`: CentOS 自动部署脚本

## 🚀 快速开始

### Windows 环境

1. 确保已安装 Python 3.8+
2. 双击运行 `deploy_windows.bat`

### CentOS 环境

1. 确保已安装 Python 3.8+
2. 运行以下命令：
   ```bash
   chmod +x deploy_centos.sh
   ./deploy_centos.sh
   ```

## 📝 手动部署步骤

### 1. 安装依赖

```bash
pip install --no-index --find-links=python-packages sherpa-onnx soundfile
```

### 2. 运行测试

```bash
cd scripts
python test_tts.py
```

## 🔧 故障排除

### 问题1：导入 sherpa_onnx 失败

**解决方案**：
- 检查 Python 版本是否为 3.8+
- 确认是否正确安装了所有依赖包

### 问题2：找不到模型文件

**解决方案**：
- 检查 `models/vits-melo-tts-zh_en/` 目录下是否有以下文件：
  - model.onnx
  - lexicon.txt
  - tokens.txt

### 问题3：CentOS 编译错误

**解决方案**：
```bash
sudo yum install -y gcc gcc-c++ make python3-devel
```

## 📞 技术支持

- 官方文档：https://k2-fsa.github.io/sherpa/onnx/tts/
- GitHub：https://github.com/k2-fsa/sherpa-onnx

## 📄 模型信息

- **模型名称**: vits-melo-tts-zh_en
- **支持语言**: 中文 + 英文
- **采样率**: 44100 Hz
- **模型大小**: 163 MB
- **说话人数量**: 1
"@ | Out-File -Encoding UTF8 README.md
```

### 5. 打包部署包

```powershell
# 使用 7-Zip 打包
"C:\Program Files\7-Zip\7z.exe" a -ttar tts-deploy-package.tar D:\tts-deploy-package\*
"C:\Program Files\7-Zip\7z.exe" a -tbzip2 tts-deploy-package.tar.bz2 tts-deploy-package.tar

# 或使用 PowerShell 压缩
Compress-Archive -Path D:\tts-deploy-package\* -DestinationPath tts-deploy-package.zip
```

---

## 🐧 CentOS 服务器部署

### 1. 传输部署包到 CentOS 服务器

```bash
# 在 Windows 上使用 scp 或 WinSCP 工具传输
# 或者使用 U盘、移动硬盘等物理介质

# 假设文件已上传到 /opt/tts-deploy-package.tar.bz2
```

### 2. 解压部署包

```bash
cd /opt
tar -xjf tts-deploy-package.tar.bz2
cd tts-deploy-package
```

### 3. 安装系统依赖

```bash
# CentOS 7
sudo yum install -y python3 python3-devel gcc gcc-c++ make

# CentOS 8/Stream
sudo dnf install -y python3 python3-devel gcc gcc-c++ make
```

### 4. 运行部署脚本

```bash
chmod +x deploy_centos.sh
./deploy_centos.sh
```

### 5. 手动部署（如果自动脚本失败）

```bash
# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip3 install --no-index --find-links=python-packages sherpa-onnx soundfile

# 运行测试
cd scripts
python3 test_tts.py
```

### 6. 验证部署

```bash
# 检查生成的音频文件
ls -lh scripts/*.wav

# 播放音频测试（如果有音频设备）
# aplay test_chinese.wav
```

---

## 🔐 生产环境部署建议

### 1. 创建 systemd 服务（可选）

如果需要将 TTS 作为后台服务运行，可以创建 systemd 服务：

```bash
sudo nano /etc/systemd/system/tts-service.service
```

```ini
[Unit]
Description=Sherpa-ONNX TTS Service
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/opt/tts-deploy-package
Environment="VIRTUAL_ENV=/opt/tts-deploy-package/venv"
Environment="PATH=$VIRTUAL_ENV/bin:$PATH"
ExecStart=/opt/tts-deploy-package/venv/bin/python3 /opt/tts-deploy-package/scripts/tts_server.py
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable tts-service
sudo systemctl start tts-service
sudo systemctl status tts-service
```

### 2. 性能优化

```python
# 在配置中调整线程数以优化性能
tts_config = sherpa_onnx.OfflineTtsConfig(
    model=sherpa_onnx.OfflineTtsModelConfig(
        vits=sherpa_onnx.OfflineTtsVitsModelConfig(...),
        num_threads=8,  # 根据服务器 CPU 核心数调整（建议为核心数的 50-80%）
        provider="cpu",
    ),
)
```

### 3. 内存管理

- **单次合成**: 建议文本长度不超过 500 字
- **批量处理**: 使用 `max_num_sentences` 参数控制批处理大小
- **服务器配置**: 推荐至少 2GB 可用内存

---

## ⚠️ 常见问题

### Q1: 模型加载速度慢？

**A**: 首次加载会较慢（5-10秒），后续调用会快很多。可以在服务启动时预加载模型。

### Q2: RTF (实时率) 是什么？

**A**: RTF < 1 表示合成速度快于音频播放速度。例如 RTF=0.5 表示合成 1 秒音频只需 0.5 秒。

### Q3: 支持哪些文本格式？

**A**: 
- ✅ 纯中文
- ✅ 纯英文
- ✅ 中英混合
- ✅ 数字（自动转换为发音）
- ⚠️ 特殊符号可能影响合成效果

### Q4: 如何添加新词到词典？

**A**: 编辑 `lexicon.txt` 文件，按格式添加新词及其拼音。参考：[添加新词教程](https://github.com/k2-fsa/sherpa-onnx/pull/1209)

---

## 📚 进阶使用

### Python API 示例

```python
import sherpa_onnx
import soundfile as sf

# 初始化 TTS
tts_config = sherpa_onnx.OfflineTtsConfig(
    model=sherpa_onnx.OfflineTtsModelConfig(
        vits=sherpa_onnx.OfflineTtsVitsModelConfig(
            model="./models/vits-melo-tts-zh_en/model.onnx",
            lexicon="./models/vits-melo-tts-zh_en/lexicon.txt",
            tokens="./models/vits-melo-tts-zh_en/tokens.txt",
        ),
        num_threads=4,
        provider="cpu",
    ),
)

tts = sherpa_onnx.OfflineTts(tts_config)

# 生成音频
text = "你好世界，Hello World！"
audio = tts.generate(text, sid=0, speed=1.0)

# 保存音频
sf.write("output.wav", audio.samples, samplerate=audio.sample_rate)

# 调整语速
audio_fast = tts.generate(text, sid=0, speed=1.5)  # 加快 50%
audio_slow = tts.generate(text, sid=0, speed=0.8)  # 减慢 20%
```

### C++ API 示例

参考项目中的 `c-api-examples/offline-tts-c-api.c`

---

## 📊 性能基准测试

| 硬件配置 | CPU | 线程数 | RTF | 
|---------|-----|-------|-----|
| Raspberry Pi 4 | Cortex-A72 | 4 | 0.156 |
| 标准服务器 | Intel Xeon | 8 | 0.05-0.10 |
| 笔记本 | Intel i5 | 4 | 0.10-0.15 |

*注：RTF 越低越好，< 1 表示可实时合成*

---

## 🆘 获取帮助

- **官方文档**: https://k2-fsa.github.io/sherpa/onnx/tts/pretrained_models/vits.html
- **GitHub Issues**: https://github.com/k2-fsa/sherpa-onnx/issues
- **模型下载**: https://github.com/k2-fsa/sherpa-onnx/releases/tag/tts-models

---

**版本信息**:
- sherpa-onnx: 1.12.14
- 模型: vits-melo-tts-zh_en
- 文档更新日期: 2024-10-21

